// Jenkinsfile-CD (function-style)
def runCD() {
    // Variables
    def NODE_IP = "13.233.21.199"          // EC2 public IP
    def EC2_NAME = "ec2-user"
    def PIPELINE_NAME = "CI-CD-Pipeline"   // Name of your master pipeline job
    def PROJECT_NAME = "DevopsProject1"

    // Stage 1: Copy Kubernetes manifests
    stage("1. Pull Files") {
        sshagent(['my_ec2_creds']) {
            sh "scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/${PIPELINE_NAME}/${PROJECT_NAME}/deployment.yaml ${EC2_NAME}@${NODE_IP}:/home/ec2-user/"
            sh "scp -o StrictHostKeyChecking=no /var/lib/jenkins/workspace/${PIPELINE_NAME}/${PROJECT_NAME}/service.yaml ${EC2_NAME}@${NODE_IP}:/home/ec2-user/"
        }
    }

    // Stage 2: Manual approval
    stage('2. Approval') {
        input message: 'Approve deployment to Kubernetes?'
    }

    // Stage 3: Deploy to Kubernetes
    stage("3. Deployment") {
        sshagent(['my_ec2_creds']) {
            sh "ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} kubectl apply -f /home/ec2-user/deployment.yaml"
            sh "ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} kubectl apply -f /home/ec2-user/service.yaml"
            sh "ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} kubectl rollout restart deploy"
            sh "ssh -o StrictHostKeyChecking=no ${EC2_NAME}@${NODE_IP} kubectl get service"
        }
    }
}

return this
